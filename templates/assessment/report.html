{% extends 'base.html' %} 

{% block title %}>_ WVAT // Assessment Report{% endblock title %}

{% block content %}
<div class="container">

  <!-- Report Header -->
  <section class="panel-section">
    <div class="section-header">
      <h2 class="section-title">Assessment_Report</h2>
      <span class="section-badge">Complete</span>
    </div>

    <div class="stats-grid">
      <div class="stat-card medium">
        <div class="stat-label">Client</div>
        <div class="stat-value" style="font-size: 18px; word-break: break-word;">{{ assessment.client.get_full_name }}</div>
      </div>

      <div class="stat-card medium">
        <div class="stat-label">Target</div>
        <div class="stat-value" style="font-size: 16px; word-break: break-all;">
          <a href="{{ assessment.website }}" target="_blank">{{ assessment.website }}</a>
        </div>
      </div>

      <div class="stat-card medium">
        <div class="stat-label">Tested On</div>
        <div class="stat-value" style="font-size: 18px;">{{ assessment.tested_on|date:"Y-m-d H:i:s" }}</div>
      </div>

      <div class="stat-card {{ nuclei_logs|length|yesno:'high,low' }}">
        <div class="stat-label">Total Issues</div>
        <div class="stat-value">{{ nuclei_logs|length }}</div>
      </div>
    </div>

    <div style="display: flex; justify-content: flex-end; margin-top: 24px; gap: 16px;">
      <button type="button" onclick="openPdfModal('simple')" class="btn-primary btn-info">
        SIMPLE_REPORT_[PDF]
      </button>
      <button type="button" onclick="openPdfModal('technical')" class="btn-primary btn-info">
        TECHNICAL_REPORT_[PDF]
      </button>
    </div>

    <!-- Password Modal -->
    <div id="pdf-password-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center;">
      <form id="pdf-form" method="post" action="{% url 'view_report_pdf' assessment.id %}" style="background: var(--bg-panel); border: 1px solid var(--neon-cyan); padding: 32px; width: 400px; max-width: 90%; box-shadow: 0 0 20px rgba(0, 229, 255, 0.2);">
        {% csrf_token %}
        <h3 style="color: var(--neon-cyan); margin-bottom: 24px; font-family: var(--font-hud); letter-spacing: 2px;">SECURE DOWNLOAD</h3>
        <p style="color: var(--text-dim); margin-bottom: 24px; font-size: 14px;">Enter your login password to encrypt and download the report.</p>
        
        <input type="hidden" name="type" id="pdf-type-input">
        
        <div style="margin-bottom: 24px;">
          <label style="display: block; color: var(--text-bright); margin-bottom: 8px; font-size: 12px; font-family: var(--font-hud);">PASSWORD</label>
          <input type="password" name="password" required class="form-control" style="width: 100%;">
        </div>
        
        <div style="display: flex; justify-content: flex-end; gap: 12px;">
          <button type="button" onclick="document.getElementById('pdf-password-modal').style.display='none'" class="btn-secondary">CANCEL</button>
          <button type="submit" class="btn-primary btn-info">DOWNLOAD_ENCRYPTED</button>
        </div>
      </form>
    </div>

    <script>
      function openPdfModal(type) {
        document.getElementById('pdf-type-input').value = type;
        document.getElementById('pdf-password-modal').style.display = 'flex';
      }
      
      // Close modal if clicking outside
      document.getElementById('pdf-password-modal').addEventListener('click', function(e) {
          if (e.target === this) {
              this.style.display = 'none';
          }
      });
    </script>
  </section>

  <!-- Nuclei Logs Header & Filtering -->
  <div class="results-header" style="display: block; margin-bottom: 24px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h3 class="results-title">Assessment Results</h3>
      <span class="results-count">
        {% if search_query or selected_tags %}
          FOUND: {{ nuclei_logs|length }}
        {% else %}
          TOTAL: {{ nuclei_logs|length }}
        {% endif %}
      </span>
    </div>

    <!-- Filter Form -->
    <form method="get" style="background: var(--bg-panel); border: 1px solid var(--border-tech); padding: 16px;">
      <div style="display: flex; gap: 16px; flex-wrap: wrap;">
        
        <!-- Search -->
        <div style="flex: 2; min-width: 200px;">
          <input type="text" name="search" class="form-control" placeholder="SEARCH BY NAME, ID, DESCRIPTION..." value="{{ search_query|default:'' }}">
        </div>

        <!-- Tag Filter (Combobox) -->
        <div style="flex: 1; min-width: 250px; position: relative;">
          <!-- Visible Input for Searching/Filtering -->
          <div style="position: relative;">
            <input 
              type="text" 
              id="tag-search-input" 
              class="form-control" 
              placeholder="SELECT TAGS..." 
              autocomplete="off"
              style="cursor: text;"
            >
            <div style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--neon-cyan);">
              ▼
            </div>
          </div>

          <!-- Dropdown Options -->
          <div id="tag-dropdown" style="
              display: none;
              position: absolute; 
              top: 100%; 
              left: 0; 
              width: 100%; 
              max-height: 300px; 
              overflow-y: auto; 
              background: var(--bg-elevated); 
              border: 1px solid var(--border-tech); 
              border-top: none; 
              z-index: 1000;
              box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            ">
            {% for tag in all_tags %}
              <div 
                class="combobox-option {% if tag in selected_tags %}selected{% endif %}" 
                data-value="{{ tag }}"
                style="
                  padding: 10px 12px; 
                  cursor: pointer; 
                  font-family: var(--font-hud); 
                  font-size: 12px; 
                  color: var(--text-dim);
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  border-bottom: 1px solid rgba(255,255,255,0.05);
                "
              >
                <span>{{ tag }}</span>
                <span class="check-mark" style="color: var(--neon-green); {% if tag not in selected_tags %}display: none;{% endif %}">[x]</span>
              </div>
            {% endfor %}
            <div id="no-tags-found" style="display: none; padding: 12px; color: var(--text-dim); font-size: 12px; font-style: italic;">NO TAGS FOUND</div>
          </div>

          <!-- Hidden Inputs for Form Submission -->
          <div id="hidden-tag-inputs">
            {% for tag in selected_tags %}
              <input type="hidden" name="tag" value="{{ tag }}">
            {% endfor %}
          </div>
        </div>

        <script>
          (function() {
            const searchInput = document.getElementById('tag-search-input');
            const dropdown = document.getElementById('tag-dropdown');
            const options = dropdown.getElementsByClassName('combobox-option');
            const hiddenInputsContainer = document.getElementById('hidden-tag-inputs');
            const noTagsMsg = document.getElementById('no-tags-found');

            // Toggle Dropdown
            searchInput.addEventListener('focus', () => {
              dropdown.style.display = 'block';
            });

            // Close when clicking outside
            document.addEventListener('click', (e) => {
              if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
              }
            });

            // Filter Logic
            searchInput.addEventListener('input', (e) => {
              const term = e.target.value.toLowerCase();
              let hasVisible = false;
              
              Array.from(options).forEach(opt => {
                const text = opt.innerText.toLowerCase();
                if (text.includes(term)) {
                  opt.style.display = 'flex';
                  hasVisible = true;
                } else {
                  opt.style.display = 'none';
                }
              });

              noTagsMsg.style.display = hasVisible ? 'none' : 'block';
              dropdown.style.display = 'block'; // Re-open if closed
            });

            // Selection Logic
            Array.from(options).forEach(opt => {
              // Initial Style Set
              if (opt.classList.contains('selected')) {
                opt.style.background = 'rgba(0, 227, 150, 0.1)';
                opt.style.color = 'var(--neon-green)';
              }

              // Hover Effects
              opt.addEventListener('mouseover', () => {
                opt.style.background = 'var(--bg-panel)';
                opt.style.color = 'var(--text-bright)';
              });

              opt.addEventListener('mouseout', () => {
                if (opt.classList.contains('selected')) {
                  opt.style.background = 'rgba(0, 227, 150, 0.1)';
                  opt.style.color = 'var(--neon-green)';
                } else {
                  opt.style.background = 'transparent';
                  opt.style.color = 'var(--text-dim)';
                }
              });

              opt.addEventListener('click', () => {
                const value = opt.dataset.value;
                const isSelected = opt.classList.toggle('selected');
                const check = opt.querySelector('.check-mark');

                if (isSelected) {
                  // Style - maintain hover/selected state immediately
                  // Mouseover logic will take over if mouse is still there, 
                  // but we set underlying state for mouseout
                  check.style.display = 'block';
                  
                  // Add Hidden Input
                  const input = document.createElement('input');
                  input.type = 'hidden';
                  input.name = 'tag';
                  input.value = value;
                  input.id = 'tag-input-' + value.replace(/[^a-zA-Z0-9]/g, '-');
                  hiddenInputsContainer.appendChild(input);
                } else {
                  // Style
                  check.style.display = 'none';
                  
                  // Remove Hidden Input
                  const input = document.getElementById('tag-input-' + value.replace(/[^a-zA-Z0-9]/g, '-'));
                  if (input) input.remove();
                  // Fallback if ID generation failed (e.g. strict match)
                  else {
                     const inputs = hiddenInputsContainer.querySelectorAll('input[value="' + value.replace(/"/g, '\\"') + '"]');
                     inputs.forEach(i => i.remove());
                  }
                }
              });
            });
          })();
        </script>

        <!-- Actions -->
        <div style="display: flex; gap: 8px; align-items: flex-start;">
          <button type="submit" class="btn-primary">
            SEARCH_RESULTS
          </button>
        </div>
      </div>

      <!-- Active Filter Badges -->
      {% if search_query or selected_tags %}
      <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-tech); display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
        <span style="font-family: var(--font-hud); font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px;">Active Filters:</span>
        
        {% if search_query %}
        <span class="section-badge" style="display: inline-flex; align-items: center; gap: 8px; padding: 4px 8px; background: var(--bg-elevated); color: var(--neon-cyan); border: 1px solid var(--neon-cyan);">
          SEARCH: "{{ search_query }}"
          <a href="?{% for t in selected_tags %}tag={{ t }}&{% endfor %}" style="color: var(--neon-cyan); text-decoration: none; font-weight: bold; margin-left: 4px; font-size: 14px; line-height: 1;">✕</a>
        </span>
        {% endif %}

        {% for tag_filter in active_tag_filters %}
        <span class="section-badge" style="display: inline-flex; align-items: center; gap: 8px; padding: 4px 8px; background: var(--bg-elevated); color: var(--neon-green); border: 1px solid var(--neon-green);">
          TAG: "{{ tag_filter.name }}"
          <a href="{{ tag_filter.remove_url }}{% if search_query %}&search={{ search_query }}{% endif %}" style="color: var(--neon-green); text-decoration: none; font-weight: bold; margin-left: 4px; font-size: 14px; line-height: 1;">✕</a>
        </span>
        {% endfor %}

        <a href="?" class="section-badge" style="display: inline-flex; align-items: center; padding: 4px 8px; background: transparent; color: var(--neon-pink); border: 1px solid var(--neon-pink); text-decoration: none; cursor: pointer; margin-left: auto;">
          [ CLEAR_ALL ]
        </a>
      </div>
      {% endif %}
    </form>
  </div>

  <div class="vuln-list">
    {% if nuclei_logs %} 
      {% for log in nuclei_logs %}
        <article class="vuln-card {{ log.info.severity|lower|default:'info' }}">
          
          <!-- Header: Template ID, Type, Severity -->
          <div class="vuln-header">
            <div class="vuln-title-group">
              <h4 class="vuln-title">{{ log.info.name|default:log.template_id }}</h4>
              <div class="vuln-id">
                {{ log.template_id }}
                <span style="margin: 0 8px; color: var(--border-tech);">|</span>
                {{ log.type|upper }}
                <span style="margin: 0 8px; color: var(--border-tech);">|</span>
                {{ log.timestamp }}
              </div>
            </div>
            <span class="vuln-severity {{ log.info.severity|lower|default:'info' }}">
              {{ log.info.severity|upper|default:"INFO" }}
            </span>
          </div>

          <div class="vuln-body">
            <!-- Description -->
            {% if log.info.description %}
            <div class="vuln-description">
              <span class="vuln-meta-label" style="display: block; margin-bottom: 8px;">DESCRIPTION</span>
              {{ log.info.description }}
            </div>
            {% endif %}

            <!-- Metadata Grid -->
            <div style="margin-bottom: 24px;">
              <div class="vuln-meta">
                <!-- Classification -->
                {% for key, value in log.info.classification.items %}
                  {% if value %}
                  <div class="vuln-meta-item">
                    <span class="vuln-meta-label">{{ key }}</span>
                    <span class="vuln-meta-value">{{ value }}</span>
                  </div>
                  {% endif %}
                {% endfor %}

                <!-- Core Target Info -->
                {% if log.host %}
                <div class="vuln-meta-item">
                  <span class="vuln-meta-label">Host</span>
                  <span class="vuln-meta-value">{{ log.host }}</span>
                </div>
                {% endif %}

                {% if log.ip %}
                <div class="vuln-meta-item">
                  <span class="vuln-meta-label">IP</span>
                  <span class="vuln-meta-value">{{ log.ip }}</span>
                </div>
                {% endif %}

                {% if log.port %}
                <div class="vuln-meta-item">
                  <span class="vuln-meta-label">Port</span>
                  <span class="vuln-meta-value">{{ log.port }}</span>
                </div>
                {% endif %}
                
                {% if log.matcher_name %}
                <div class="vuln-meta-item">
                  <span class="vuln-meta-label">Matcher</span>
                  <span class="vuln-meta-value" style="color: var(--neon-pink);">{{ log.matcher_name }}</span>
                </div>
                {% endif %}
              </div>
            </div>

            <!-- Tags -->
            {% if log.info.tags %}
            <div style="margin-bottom: 24px;">
              <span class="vuln-meta-label" style="display: block; margin-bottom: 8px;">TAGS</span>
              <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                {% for tag in log.info.tags %}
                  <a href="?tag={{ tag }}" class="section-badge" style="text-decoration: none; cursor: pointer;">
                    {{ tag }}
                  </a>
                {% endfor %}
              </div>
            </div>
            {% endif %}

            <!-- Extracted Results -->
            {% if log.extracted_results %}
            <div style="margin-bottom: 24px;">
              <div class="vuln-meta-label" style="margin-bottom: 8px;">Extracted Results</div>
              <div class="vuln-path">
                <ul style="margin: 0; padding-left: 16px; list-style-type: none;">
                  {% for result in log.extracted_results %}
                    <li style="margin-bottom: 4px; word-break: break-all;">
                      <span style="color: var(--neon-green); margin-right: 8px;">➜</span>{{ result }}
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </div>
            {% endif %}

            <!-- Technical Details -->
            <div style="margin-top: 32px;">
              <details class="tech-details">
                <summary class="btn-secondary" style="display: inline-block; width: auto; list-style: none;">
                  > VIEW TECHNICAL DETAILS
                </summary>
                
                <div style="margin-top: 24px; display: grid; gap: 24px;">
                  {% if log.curl_command %}
                  <div>
                    <span class="vuln-meta-label" style="display: block; margin-bottom: 8px;">Reproduce (cURL)</span>
                    <div class="vuln-path" style="color: var(--text-dim); white-space: pre-wrap;">{{ log.curl_command }}</div>
                  </div>
                  {% endif %}

                  {% if log.request %}
                  <div>
                     <span class="vuln-meta-label" style="display: block; margin-bottom: 8px;">Request</span>
                     <div class="vuln-path" style="color: var(--neon-cyan); max-height: 300px; overflow-y: auto; white-space: pre-wrap;">{{ log.request }}</div>
                  </div>
                  {% endif %}

                  {% if log.response %}
                  <div>
                     <span class="vuln-meta-label" style="display: block; margin-bottom: 8px;">Response</span>
                     <div class="vuln-path" style="color: var(--neon-green); max-height: 400px; overflow-y: auto; white-space: pre-wrap;">{{ log.response }}</div>
                  </div>
                  {% endif %}

                  {% if log.info.reference %}
                  <div>
                    <span class="vuln-meta-label" style="display: block; margin-bottom: 8px;">References</span>
                    <ul style="margin: 0; padding-left: 0; list-style: none;">
                      {% for ref in log.info.reference %}
                        <li style="margin-bottom: 8px;">
                          <a href="{{ ref }}" target="_blank" style="font-size: 12px; display: flex; align-items: center; gap: 8px;">
                            <span style="color: var(--neon-cyan);">↗</span> {{ ref }}
                          </a>
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% endif %}
                </div>
              </details>
            </div>
          </div>
        </article>
      {% endfor %}
    {% else %}
    <div class="panel-section">
      <div style="text-align: center; padding: 40px">
        <h3 class="section-title" style="margin-bottom: 16px; color: var(--text-dim);">NO_LOGS_AVAILABLE</h3>
        <p style="font-size: 14px; color: var(--text-dim)">
          The raw Nuclei output file could not be found or is empty.
        </p>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock content %}

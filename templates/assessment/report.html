{% extends 'base.html' %} 

{% block title %}>_ WVAT // Assessment Report{% endblock title %}

{% block content %}
<div class="container">

  <!-- Report Header -->
  <section class="panel-section">
    <div class="section-header">
      <h2 class="section-title">Assessment_Report</h2>
      <span class="section-badge">Complete</span>
    </div>

    <div class="stats-grid">
      <div class="stat-card medium">
        <div class="stat-label">Client</div>
        <div class="stat-value" style="font-size: 18px; word-break: break-word;">{{ assessment.client.get_full_name }}</div>
      </div>

      <div class="stat-card medium">
        <div class="stat-label">Target</div>
        <div class="stat-value" style="font-size: 16px; word-break: break-all;">
          <a href="{{ assessment.website }}" target="_blank">{{ assessment.website }}</a>
        </div>
      </div>

      <div class="stat-card medium">
        <div class="stat-label">Tested On</div>
        <div class="stat-value" style="font-size: 18px;">{{ assessment.tested_on|date:"Y-m-d H:i:s" }}</div>
      </div>

      <div class="stat-card {{ nuclei_logs|length|yesno:'high,low' }}">
        <div class="stat-label">Total Issues</div>
        <div class="stat-value">{{ nuclei_logs|length }}</div>
      </div>
    </div>

    <div style="display: flex; justify-content: flex-end; margin-top: 24px;">
      <a href="{% url 'view_report_pdf' assessment.id %}" class="btn-info">
        DOWNLOAD_PDF
      </a>
    </div>
  </section>

  <!-- Nuclei Logs Header & Filtering -->
  <div class="results-header" style="display: block; margin-bottom: 24px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h3 class="results-title">Assessment Results</h3>
      <span class="results-count">
        {% if search_query or tag_filter %}
          FOUND: {{ nuclei_logs|length }}
        {% else %}
          TOTAL: {{ nuclei_logs|length }}
        {% endif %}
      </span>
    </div>

    <!-- Filter Form -->
    <form method="get" style="background: var(--bg-panel); border: 1px solid var(--border-tech); padding: 16px;">
      <div style="display: flex; gap: 16px; flex-wrap: wrap;">
        
        <!-- Search -->
        <div style="flex: 2; min-width: 200px;">
          <input type="text" name="search" class="form-control" placeholder="SEARCH BY NAME, ID, DESCRIPTION..." value="{{ search_query|default:'' }}">
        </div>

        <!-- Tag Filter -->
        <div style="flex: 1; min-width: 150px;">
          <select name="tag" class="form-control" style="background-image: none; cursor: pointer;">
            <option value="">-- ALL TAGS --</option>
            {% for tag in all_tags %}
              <option value="{{ tag }}" {% if tag == tag_filter %}selected{% endif %}>{{ tag }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Actions -->
        <div style="display: flex; gap: 8px;">
          <button type="submit" class="btn-primary">
            SEARCH_LOGS
          </button>
          
          {% if search_query or tag_filter %}
             <a href="?" class="btn-secondary" style="display: flex; align-items: center; justify-content: center;">
               CLEAR
             </a>
          {% endif %}
        </div>
      </div>
    </form>
  </div>

  <div class="vuln-list">
    {% if nuclei_logs %} 
      {% for log in nuclei_logs %}
        <article class="vuln-card {{ log.info.severity|lower|default:'info' }}">
          
          <!-- Header: Template ID, Type, Severity -->
          <div class="vuln-header">
            <div class="vuln-title-group">
              <h4 class="vuln-title">{{ log.info.name|default:log.template_id }}</h4>
              <div class="vuln-id">
                {{ log.template_id }}
                <span style="margin: 0 8px; color: var(--border-tech);">|</span>
                {{ log.type|upper }}
                <span style="margin: 0 8px; color: var(--border-tech);">|</span>
                {{ log.timestamp }}
              </div>
            </div>
            <span class="vuln-severity {{ log.info.severity|lower|default:'info' }}">
              {{ log.info.severity|upper|default:"INFO" }}
            </span>
          </div>

          <div class="vuln-body">
            <!-- Description -->
            {% if log.info.description %}
            <div class="vuln-description">
              <span class="vuln-meta-label" style="display: block; margin-bottom: 8px;">DESCRIPTION</span>
              {{ log.info.description }}
            </div>
            {% endif %}

            <!-- Metadata Grid -->
            <div style="margin-bottom: 24px;">
              <div class="vuln-meta">
                <!-- Classification -->
                {% for key, value in log.info.classification.items %}
                  {% if value %}
                  <div class="vuln-meta-item">
                    <span class="vuln-meta-label">{{ key }}</span>
                    <span class="vuln-meta-value">{{ value }}</span>
                  </div>
                  {% endif %}
                {% endfor %}

                <!-- Core Target Info -->
                {% if log.host %}
                <div class="vuln-meta-item">
                  <span class="vuln-meta-label">Host</span>
                  <span class="vuln-meta-value">{{ log.host }}</span>
                </div>
                {% endif %}

                {% if log.ip %}
                <div class="vuln-meta-item">
                  <span class="vuln-meta-label">IP</span>
                  <span class="vuln-meta-value">{{ log.ip }}</span>
                </div>
                {% endif %}

                {% if log.port %}
                <div class="vuln-meta-item">
                  <span class="vuln-meta-label">Port</span>
                  <span class="vuln-meta-value">{{ log.port }}</span>
                </div>
                {% endif %}
                
                {% if log.matcher_name %}
                <div class="vuln-meta-item">
                  <span class="vuln-meta-label">Matcher</span>
                  <span class="vuln-meta-value" style="color: var(--neon-pink);">{{ log.matcher_name }}</span>
                </div>
                {% endif %}
              </div>
            </div>

            <!-- Tags -->
            {% if log.info.tags %}
            <div style="margin-bottom: 24px;">
              <span class="vuln-meta-label" style="display: block; margin-bottom: 8px;">TAGS</span>
              <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                {% for tag in log.info.tags %}
                  <a href="?tag={{ tag }}" class="section-badge" style="text-decoration: none; cursor: pointer;">
                    {{ tag }}
                  </a>
                {% endfor %}
              </div>
            </div>
            {% endif %}

            <!-- Extracted Results -->
            {% if log.extracted_results %}
            <div style="margin-bottom: 24px;">
              <div class="vuln-meta-label" style="margin-bottom: 8px;">Extracted Results</div>
              <div class="vuln-path">
                <ul style="margin: 0; padding-left: 16px; list-style-type: none;">
                  {% for result in log.extracted_results %}
                    <li style="margin-bottom: 4px; word-break: break-all;">
                      <span style="color: var(--neon-green); margin-right: 8px;">➜</span>{{ result }}
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </div>
            {% endif %}

            <!-- Technical Details -->
            <div style="margin-top: 32px;">
              <details class="tech-details">
                <summary class="btn-secondary" style="display: inline-block; width: auto; list-style: none;">
                  > VIEW TECHNICAL DETAILS
                </summary>
                
                <div style="margin-top: 24px; display: grid; gap: 24px;">
                  {% if log.curl_command %}
                  <div>
                    <span class="vuln-meta-label" style="display: block; margin-bottom: 8px;">Reproduce (cURL)</span>
                    <div class="vuln-path" style="color: var(--text-dim); white-space: pre-wrap;">{{ log.curl_command }}</div>
                  </div>
                  {% endif %}

                  {% if log.request %}
                  <div>
                     <span class="vuln-meta-label" style="display: block; margin-bottom: 8px;">Request</span>
                     <div class="vuln-path" style="color: var(--neon-cyan); max-height: 300px; overflow-y: auto; white-space: pre-wrap;">{{ log.request }}</div>
                  </div>
                  {% endif %}

                  {% if log.response %}
                  <div>
                     <span class="vuln-meta-label" style="display: block; margin-bottom: 8px;">Response</span>
                     <div class="vuln-path" style="color: var(--neon-green); max-height: 400px; overflow-y: auto; white-space: pre-wrap;">{{ log.response }}</div>
                  </div>
                  {% endif %}

                  {% if log.info.reference %}
                  <div>
                    <span class="vuln-meta-label" style="display: block; margin-bottom: 8px;">References</span>
                    <ul style="margin: 0; padding-left: 0; list-style: none;">
                      {% for ref in log.info.reference %}
                        <li style="margin-bottom: 8px;">
                          <a href="{{ ref }}" target="_blank" style="font-size: 12px; display: flex; align-items: center; gap: 8px;">
                            <span style="color: var(--neon-cyan);">↗</span> {{ ref }}
                          </a>
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% endif %}
                </div>
              </details>
            </div>
          </div>
        </article>
      {% endfor %}
    {% else %}
    <div class="panel-section">
      <div style="text-align: center; padding: 40px">
        <h3 class="section-title" style="margin-bottom: 16px; color: var(--text-dim);">NO_LOGS_AVAILABLE</h3>
        <p style="font-size: 14px; color: var(--text-dim)">
          The raw Nuclei output file could not be found or is empty.
        </p>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock content %}
